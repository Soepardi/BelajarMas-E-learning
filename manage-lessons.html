<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Pelajaran - BelajarMas</title>
    <link rel="icon" type="image/x-icon" href="assets/images/icon.ico">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-white text-brand-black min-h-screen font-sans">
    
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute bottom-[20%] right-[10%] w-[30%] h-[30%] bg-brand-teal/5 rounded-full blur-[100px]"></div>
    </div>

    <div id="app" class="flex min-h-screen">
        <div id="sidebar-container"></div>
        <main class="flex-1 md:ml-64 relative w-full">
            <div id="mobile-header-container"></div>
            <div class="p-6 md:p-10 max-w-7xl mx-auto space-y-8 animate-fade-in">
                <header class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-heading font-bold text-brand-black mb-2">Manage Lessons</h1>
                        <p class="text-gray-500">Create, edit, and organize your course materials.</p>
                    </div>
                    <button onclick="openCreateLessonModal()"
                        class="px-6 py-3 rounded-xl bg-brand-black text-white font-bold hover:bg-gray-800 transition-all shadow-lg shadow-brand-black/20 transform hover:-translate-y-0.5 flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span>New Lesson</span>
                    </button>
                </header>



                <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead
                                class="bg-gray-50 border-b border-gray-100 text-gray-500 text-sm uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-4 font-medium">Lesson Title</th>
                                    <th class="px-6 py-4 font-medium">Category</th>
                                    <th class="px-6 py-4 font-medium">Students</th>
                                    <th class="px-6 py-4 font-medium">Status</th>
                                    <th class="px-6 py-4 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lessonsTableBody" class="divide-y divide-gray-100 text-sm">
                                <tr class="animate-pulse">
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-400">Loading lessons...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>
        </main>
    </div>

    
    <div id="createLessonModal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
        <div class="w-full max-w-2xl bg-white rounded-2xl p-8 relative shadow-2xl max-h-[90vh] overflow-y-auto">
            <button onclick="closeCreateLessonModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-heading font-bold text-brand-black mb-1">Create New Lesson</h2>
            <p class="text-gray-500 text-sm mb-6">Start a new topic for your students.</p>

            <form id="createLessonForm" class="space-y-6">
                <input type="hidden" id="editLessonId">
                <input type="hidden" id="currentVideoUrl">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Title</label>
                        <input type="text" id="lessonTitle" required
                            class="w-full px-4 py-3 bg-gray-50 rounded-xl border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-brand-teal focus:bg-white outline-none transition-all font-medium text-brand-black placeholder:text-gray-400">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Category</label>
                        <select id="lessonCategory" required
                            class="w-full px-4 py-3 bg-gray-50 rounded-xl border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-brand-teal focus:bg-white outline-none transition-all font-medium text-brand-black">
                            <option value="Grammar">Grammar</option>
                            <option value="Vocabulary">Vocabulary</option>
                            <option value="Reading">Reading</option>
                            <option value="Speaking">Speaking</option>
                            <option value="Business">Business</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Description</label>
                    <textarea id="lessonDescription" rows="3"
                        class="w-full px-4 py-3 bg-gray-50 rounded-xl border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-brand-teal focus:bg-white outline-none transition-all resize-none font-medium text-brand-black placeholder:text-gray-400"></textarea>
                </div>

                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1 mb-2 block">Lesson
                        Material (Video/Audio)</label>
                    <div class="flex gap-6 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="videoSource" value="upload" checked
                                class="accent-brand-teal w-4 h-4 cursor-pointer" onchange="toggleVideoInput()">
                            <span
                                class="text-sm font-medium text-gray-600 group-hover:text-brand-teal transition-colors">File
                                Upload</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="videoSource" value="youtube"
                                class="accent-brand-teal w-4 h-4 cursor-pointer" onchange="toggleVideoInput()">
                            <span
                                class="text-sm font-medium text-gray-600 group-hover:text-brand-teal transition-colors">YouTube
                                URL</span>
                        </label>
                    </div>

                    
                    <div id="uploadInput"
                        class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:bg-gray-50 hover:border-brand-teal/50 transition-all cursor-pointer relative group">
                        <input type="file" id="videoFile" accept="video/*,audio/*"
                            class="absolute inset-0 opacity-0 cursor-pointer z-10"
                            onchange="document.getElementById('fileName').textContent = this.files[0]?.name || ''">
                        <div
                            class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-teal-50 group-hover:text-brand-teal transition-colors text-gray-400">
                            <i class="fas fa-cloud-upload-alt text-xl"></i>
                        </div>
                        <p class="text-gray-600 font-medium text-sm">Click to upload video or audio</p>
                        <p class="text-gray-400 text-xs mt-1">MP4, WebM, MP3, WAV (Max 50MB)</p>
                        <p id="fileName" class="text-brand-teal text-sm font-medium mt-3"></p>
                    </div>

                    
                    <div id="youtubeInput" class="hidden">
                        <div class="relative">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                <i class="fab fa-youtube"></i>
                            </div>
                            <input type="url" id="customVideoUrl" placeholder="https://www.youtube.com/watch?v=..."
                                class="w-full pl-10 pr-4 py-3 bg-gray-50 rounded-xl border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-brand-teal focus:bg-white outline-none transition-all font-medium text-brand-black">
                        </div>
                        <p class="text-xs text-gray-400 mt-2 ml-1">Paste the full video URL.</p>
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeCreateLessonModal()"
                        class="flex-1 px-6 py-3.5 rounded-xl border-0 ring-1 ring-gray-200 text-gray-600 font-bold hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit"
                        class="flex-[2] px-6 py-3.5 rounded-xl bg-brand-teal text-white font-bold hover:bg-teal-600 shadow-lg shadow-brand-teal/20 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                        <span id="submitBtnText">Create Lesson</span>
                        <i class="fas fa-arrow-right text-sm"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { renderSidebar, renderMobileHeader } from './assets/js/components.js';
        import { checkSession, signOut } from './assets/js/auth.js';
        import { supabase } from './assets/js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkSession();
            document.getElementById('sidebar-container').innerHTML = renderSidebar('manage-lessons', 'teacher');
            document.getElementById('mobile-header-container').innerHTML = renderMobileHeader();
            document.getElementById('logoutBtn')?.addEventListener('click', signOut);



            
            window.toggleVideoInput = () => {
                const source = document.querySelector('input[name="videoSource"]:checked').value;
                const uploadInput = document.getElementById('uploadInput');
                const youtubeInput = document.getElementById('youtubeInput');

                if (source === 'upload') {
                    uploadInput.classList.remove('hidden');
                    youtubeInput.classList.add('hidden');
                } else {
                    uploadInput.classList.add('hidden');
                    youtubeInput.classList.remove('hidden');
                }
            };

            
            const createModal = document.getElementById('createLessonModal');
            const createForm = document.getElementById('createLessonForm');

            window.openCreateLessonModal = () => {
                createModal.classList.remove('hidden');
            };

            window.closeCreateLessonModal = () => {
                createModal.classList.add('hidden');
                createForm.reset();
                document.getElementById('editLessonId').value = '';
                document.getElementById('currentVideoUrl').value = '';
                document.getElementById('fileName').textContent = '';
                document.getElementById('submitBtnText').textContent = 'Create Lesson';
                
                const modalTitle = createModal.querySelector('h2');
                if (modalTitle) modalTitle.textContent = 'Create New Lesson';

                
                const uploadRadio = document.querySelector('input[name="videoSource"][value="upload"]');
                if (uploadRadio) uploadRadio.checked = true;
                if (typeof toggleVideoInput === 'function') toggleVideoInput();
            };

            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const btn = createForm.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                try {
                    const lessonId = document.getElementById('editLessonId').value;
                    const title = document.getElementById('lessonTitle').value;
                    const category = document.getElementById('lessonCategory').value;
                    const description = document.getElementById('lessonDescription').value;
                    const videoSource = document.querySelector('input[name="videoSource"]:checked').value;
                    let videoUrl = document.getElementById('currentVideoUrl').value;

                    
                    if (videoSource === 'upload') {
                        const file = document.getElementById('videoFile').files[0];
                        if (file) {
                            const fileExt = file.name.split('.').pop();
                            const fileName = `${Math.random()}.${fileExt}`;

                            let contentType = file.type;
                            if (!contentType) {
                                if (fileExt === 'mp3') contentType = 'audio/mpeg';
                                else if (fileExt === 'wav') contentType = 'audio/wav';
                                else if (fileExt === 'ogg') contentType = 'audio/ogg';
                                else if (fileExt === 'm4a') contentType = 'audio/mp4';
                            }
                            console.log('Uploading file:', fileName, 'Type:', contentType);

                            const filePath = `content/${fileName}`;

                            const { error: uploadError } = await supabase.storage
                                .from('media')
                                .upload(filePath, file, {
                                    cacheControl: '3600',
                                    upsert: false,
                                    contentType: contentType
                                });

                            if (uploadError) throw uploadError;

                            const { data: { publicUrl } } = supabase.storage.from('media').getPublicUrl(filePath);
                            videoUrl = publicUrl;
                        }
                    } else {
                        videoUrl = document.getElementById('customVideoUrl').value;
                    }

                    if (lessonId) {
                        
                        const { error } = await supabase
                            .from('lessons')
                            .update({
                                title,
                                category,
                                description,
                                video_url: videoUrl
                            })
                            .eq('id', lessonId);

                        if (error) throw error;
                        alert('Lesson updated successfully!');
                    } else {
                        
                        const { error } = await supabase
                            .from('lessons')
                            .insert({
                                title,
                                category,
                                description,
                                video_url: videoUrl,
                                created_by: session.user.id
                            });

                        if (error) throw error;
                        alert('Lesson created successfully!');
                    }

                    closeCreateLessonModal();
                    fetchLessons();
                } catch (err) {
                    console.error(err);
                    alert('Error saving lesson: ' + err.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            async function fetchLessons() {
                const tbody = document.getElementById('lessonsTableBody');

                const { data: lessons, error } = await supabase
                    .from('lessons')
                    .select('*')
                    .eq('created_by', session.user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching lessons:', error);
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading lessons</td></tr>';
                    return;
                }

                if (lessons.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No lessons created yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = lessons.map(lesson => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900">${lesson.title}</td>
                        <td class="px-6 py-4 text-gray-500">${lesson.category || 'General'}</td>
                        <td class="px-6 py-4 text-gray-900">-</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">Active</span></td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editLesson('${lesson.id}')" class="text-gray-400 hover:text-brand-teal mx-1" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLesson('${lesson.id}')" class="text-red-300 hover:text-red-500 mx-1" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            window.editLesson = async (id) => {
                try {
                    const { data: lesson, error } = await supabase
                        .from('lessons')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    
                    document.getElementById('editLessonId').value = lesson.id;
                    document.getElementById('lessonTitle').value = lesson.title;
                    document.getElementById('lessonCategory').value = lesson.category;
                    document.getElementById('lessonDescription').value = lesson.description;
                    document.getElementById('currentVideoUrl').value = lesson.video_url || '';

                    
                    const isYouTube = lesson.video_url && (lesson.video_url.includes('youtube.com') || lesson.video_url.includes('youtu.be'));

                    if (isYouTube) {
                        document.querySelector('input[name="videoSource"][value="youtube"]').checked = true;
                        document.getElementById('customVideoUrl').value = lesson.video_url;
                        toggleVideoInput(); 
                    } else {
                        document.querySelector('input[name="videoSource"][value="upload"]').checked = true;
                        if (lesson.video_url) {
                            document.getElementById('fileName').textContent = "Current: " + lesson.video_url.split('/').pop();
                        }
                        toggleVideoInput(); 
                    }

                    
                    document.getElementById('submitBtnText').textContent = 'Update Lesson';
                    document.querySelector('.bg-white h2').textContent = 'Edit Lesson';

                    openCreateLessonModal();

                } catch (err) {
                    console.error('Error fetching lesson:', err);
                    alert('Error loading lesson for edit');
                }
            };

            
            window.goToAddExercise = (id) => {
                if (!id) return;
                console.log('Navigating to Add Exercise for ID:', id);
                
                localStorage.setItem('exerciseLessonId', id);
                
                window.location.href = `add-exercise.html?lessonId=${id}`;
            };

            window.deleteLesson = async (id) => {
                if (!confirm('Are you sure you want to delete this lesson?')) return;
                try {
                    const { error } = await supabase.from('lessons').delete().eq('id', id);
                    if (error) throw error;
                    fetchLessons();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            fetchLessons();
        });
    </script>
</body>

</html>