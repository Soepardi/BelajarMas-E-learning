<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Siswa - BelajarMas</title>
    <link rel="icon" type="image/x-icon" href="assets/images/icon.ico">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-white text-brand-black min-h-screen font-sans">

    <!-- Background Elements -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-[10%] left-[20%] w-[30%] h-[30%] bg-brand-teal/5 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[10%] right-[10%] w-[30%] h-[30%] bg-brand-orange/5 rounded-full blur-[100px]">
        </div>
    </div>

    <div id="app" class="flex min-h-screen">
        <!-- Sidebar container -->
        <div id="sidebar-container"></div>

        <main class="flex-1 md:ml-64 relative w-full">
            <!-- Mobile Header -->
            <div id="mobile-header-container"></div>

            <div class="p-6 md:p-10 max-w-7xl mx-auto space-y-8">
                <!-- Welcome Section -->
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 animate-fade-in">
                    <div>
                        <h1 class="text-3xl font-heading font-bold text-brand-black mb-2">Halo, <span id="userName"
                                class="text-brand-orange">Siswa</span> ðŸ‘‹</h1>
                        <p class="text-gray-500">Siap belajar sesuatu yang baru hari ini?</p>
                    </div>
                </header>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in" style="animation-delay: 0.1s;">
                    <div class="bg-white p-6 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-100">
                        <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-blue-500">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Jam Dihabiskan</p>
                            <h3 class="text-2xl font-bold font-heading text-brand-black">12.5</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-100">
                        <div
                            class="w-12 h-12 rounded-xl bg-orange-50 flex items-center justify-center text-brand-orange">
                            <i class="fas fa-fire text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Progres Kursus</p>
                            <h3 class="text-2xl font-bold font-heading text-brand-black">45%</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-100">
                        <div class="w-12 h-12 rounded-xl bg-green-50 flex items-center justify-center text-brand-teal">
                            <i class="fas fa-trophy text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Sertifikat</p>
                            <h3 class="text-2xl font-bold font-heading text-brand-black">1</h3>
                        </div>
                    </div>
                </div>

                <!-- Recommended Courses -->
                <section class="animate-fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-heading font-semibold text-brand-black mb-6">Direkomendasikan Untuk Anda
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="coursesGrid">
                        <!-- Loading State -->
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 animate-pulse">
                            <div class="aspect-video bg-gray-100 rounded-xl mb-4"></div>
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 animate-pulse">
                            <div class="aspect-video bg-gray-100 rounded-xl mb-4"></div>
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { renderSidebar, renderMobileHeader } from './assets/js/components.js';
        import { checkSession, signOut } from './assets/js/auth.js';
        import { supabase } from './assets/js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkSession();
            document.getElementById('sidebar-container').innerHTML = renderSidebar('dashboard', 'student');
            document.getElementById('mobile-header-container').innerHTML = renderMobileHeader();

            if (session?.user) {
                document.getElementById('userName').textContent = session.user.user_metadata.full_name || 'Siswa';
            }

            document.getElementById('logoutBtn').addEventListener('click', signOut);

            // Fetch Enrolled Courses (Progress + Lessons)
            // Note: We use the relational query syntax. Ensure foreign keys are correct in schema.
            // schema.sql logic: progress.lesson_id references lessons.id
            const { data: enrollments, error } = await supabase
                .from('progress')
                .select(`
                    *,
                    lessons (
                        id,
                        title,
                        description,
                        category
                    )
                `)
                .eq('student_id', session.user.id);

            console.log('Enrollments Data:', enrollments);
            if (error) console.error('Enrollments Error:', error);

            const grid = document.getElementById('coursesGrid');
            const recommendedTitle = document.querySelector('h2');

            // Change title to "My Learning" if user has enrollments
            if (enrollments && enrollments.length > 0) {
                recommendedTitle.textContent = "Pembelajaran Saya";
            } else {
                recommendedTitle.textContent = "Direkomendasikan Untuk Anda (Daftar untuk melihat kursus di sini)";
                // Ideally fetch random lessons here if empty, but for now we'll just show empty state or link to courses
            }

            // Stats Calculation
            const totalEnrolled = enrollments?.length || 0;
            const completedCount = enrollments?.filter(e => e.status === 'completed').length || 0;
            const progressPercent = totalEnrolled > 0 ? Math.round((completedCount / totalEnrolled) * 100) : 0;

            // Update Stats UI
            // Hours (Mock: 2 hours per enrolled course)
            document.querySelector('.fa-clock').closest('.bg-white').querySelector('h3').textContent = (totalEnrolled * 2.5).toFixed(1);
            // Progress
            document.querySelector('.fa-fire').closest('.bg-white').querySelector('h3').textContent = progressPercent + '%';
            // Certificates
            document.querySelector('.fa-trophy').closest('.bg-white').querySelector('h3').textContent = completedCount;


            if (error) {
                console.error('Error fetching enrollments:', error);
                grid.innerHTML = '<p class="text-red-500">Gagal memuat kursus Anda.</p>';
                return;
            }

            if (enrollments && enrollments.length > 0) {
                grid.innerHTML = enrollments.map(item => {
                    const lesson = item.lessons;
                    if (!lesson) return ''; // Skip if lesson deleted

                    if (!lesson.id) {
                        console.error('Missing ID for lesson:', lesson);
                        return '';
                    }

                    return `
                    <div class="bg-white p-5 rounded-2xl shadow-sm hover:shadow-xl hover:shadow-brand-teal/5 border border-gray-100 hover:border-brand-teal/20 transition-all group">
                        <div class="aspect-video rounded-xl bg-gray-100 mb-4 relative overflow-hidden flex items-center justify-center">
                            <span class="absolute top-2 right-2 px-2 py-1 rounded-md bg-white/90 text-xs font-bold text-brand-teal shadow-sm">
                                ${item.status === 'completed' ? 'Selesai' : 'Sedang Berlangsung'}
                            </span>
                            <i class="fas fa-play-circle text-4xl text-brand-teal/50 group-hover:text-brand-orange transition-colors"></i>
                        </div>
                        <span class="text-xs font-bold text-brand-teal tracking-wider uppercase mb-1 block">${lesson.category || 'Umum'}</span>
                        <h3 class="text-lg font-bold text-brand-black mb-2 line-clamp-1">${lesson.title}</h3>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2">${lesson.description}</p>
                        
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mb-4">
                            <div class="bg-brand-teal h-1.5 rounded-full" style="width: ${item.status === 'completed' ? '100%' : '10%'}"></div>
                        </div>

                        <button onclick="goToLesson('${lesson.id}')" class="block w-full text-center bg-gray-50 hover:bg-brand-teal hover:text-white text-gray-700 py-2.5 rounded-xl text-sm font-medium transition-all">
                            ${item.status === 'completed' ? 'Ulas Pelajaran' : 'Lanjutkan Belajar'}
                        </button>
                    </div>
                `;
                }).join('');
            } else {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <div class="w-16 h-16 bg-brand-cream rounded-full flex items-center justify-center mx-auto mb-4 text-brand-orange">
                            <i class="fas fa-book-open text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-brand-black mb-2">Belum ada kursus</h3>
                        <p class="text-gray-500 mb-6">Jelajahi perpustakaan kami dan mulai belajar hari ini!</p>
                        <a href="courses.html" class="px-6 py-2.5 bg-brand-teal text-white rounded-xl font-medium hover:bg-brand-teal-dark transition-all shadow-lg shadow-brand-teal/20">
                            Jelajahi Kursus
                        </a>
                    </div>
                `;
            }
        });

        // Global Navigation Function
        window.goToLesson = (id) => {
            console.log('Saving Lesson ID:', id);
            localStorage.setItem('currentLessonId', id);
            // Small delay to ensure storage writes (rarely needed but safer for dev)
            setTimeout(() => {
                window.location.href = `lesson.html?id=${id}`;
            }, 50);
        };
    </script>
</body>

</html>