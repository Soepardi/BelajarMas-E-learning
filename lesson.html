<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemutar Pelajaran - BelajarMas</title>
    <link rel="icon" type="image/x-icon" href="assets/images/icon.ico">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-white text-brand-black min-h-screen font-sans">

    <div id="app" class="flex min-h-screen">
        <div id="sidebar-container"></div>
        <main class="flex-1 md:ml-64 relative w-full">
            <div id="mobile-header-container"></div>

            <div class="p-6 md:p-10 max-w-6xl mx-auto space-y-8 animate-fade-in">
                <!-- Header -->
                <header class="flex items-center gap-4 text-gray-500 mb-6">
                    <a href="student-dashboard.html"
                        class="hover:text-brand-teal transition-colors flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Kembali ke Dasbor
                    </a>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Main Content (Video & Details) -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Video Player -->
                        <div class="bg-black rounded-2xl overflow-hidden shadow-xl aspect-video relative group">
                            <video id="lessonVideo" class="w-full h-full object-cover" controls>
                                <source src="" type="video/mp4">
                                Browser Anda tidak mendukung tag video.
                            </video>
                        </div>

                        <!-- Lesson Details -->
                        <div>
                            <span class="text-brand-orange font-bold text-sm tracking-wide uppercase mb-2 block"
                                id="lessonCategory">Kategori</span>
                            <h1 class="text-3xl font-heading font-bold text-brand-black mb-4" id="lessonTitle">Memuat
                                Pelajaran...</h1>
                            <p class="text-gray-600 leading-relaxed" id="lessonDesc">Mohon tunggu sementara pelajaran
                                dimuat.
                            </p>
                        </div>
                    </div>

                    <!-- Sidebar (Exercises & Material) -->
                    <div class="space-y-6">
                        <!-- Progress Card -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-heading font-bold text-lg mb-4 text-brand-black">Progres Anda</h3>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 mb-2">
                                <div class="bg-brand-teal h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-gray-500 text-sm">0% Selesai</p>
                        </div>

                        <!-- Exercises List -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-heading font-bold text-lg mb-4 text-brand-black">Latihan</h3>
                            <div id="exercisesList" class="space-y-3">
                                <p class="text-gray-500 text-sm italic">Memuat latihan...</p>
                            </div>
                        </div>

                        <!-- Audio Tool (Mockup) -->
                        <div class="bg-brand-teal/5 p-6 rounded-2xl border border-brand-teal/20 text-center">
                            <div
                                class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-brand-teal shadow-sm">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <h4 class="font-bold text-brand-black mb-1">Latihan Pengucapan</h4>
                            <p class="text-gray-500 text-sm mb-4">Rekam diri Anda mengucapkan frasa kunci.</p>
                            <button
                                class="bg-brand-teal text-white w-full py-2 rounded-lg font-medium hover:bg-brand-teal-dark transition-colors">Mulai
                                Merekam</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Exercise Modal -->
    <div id="exerciseModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
        <div class="w-full max-w-lg bg-white rounded-2xl p-8 relative shadow-2xl">
            <button onclick="document.getElementById('exerciseModal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div id="modalContent">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script type="module">
        import { renderSidebar, renderMobileHeader } from './assets/js/components.js';
        import { checkSession, signOut } from './assets/js/auth.js';
        import { supabase } from './assets/js/supabaseClient.js';

        // ... existing JS logic ...
        // (Copying logic from previous lesson.html but updating IDs/Colors in JS if usually needed, 
        //  but logic here is mostly data-binding. I will include the full script below for safety)

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let lessonId = urlParams.get('id');

            const session = await checkSession();
            document.getElementById('sidebar-container').innerHTML = renderSidebar('courses', 'student');
            document.getElementById('mobile-header-container').innerHTML = renderMobileHeader();
            document.getElementById('logoutBtn')?.addEventListener('click', signOut);

            if (!lessonId) {
                console.log('URL Search Params Missing. Checking LocalStorage...');
                lessonId = localStorage.getItem('currentLessonId');

                if (!lessonId) {
                    console.log('URL Search Params:', window.location.search);
                    alert('Error: Tidak ada ID pelajaran ditemukan di URL atau Penyimpanan. URL: ' + window.location.href);
                    return;
                } else {
                    console.log('Recovered Lesson ID from Storage:', lessonId);
                    // Optional: Update URL to look correct without reloading
                    const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + lessonId;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                }
            }

            // Load Lesson Data
            const { data: lesson, error } = await supabase
                .from('lessons')
                .select('*')
                .eq('id', lessonId)
                .single();

            if (error) {
                console.error(error);
                document.getElementById('lessonTitle').textContent = 'Gagal memuat pelajaran';
            } else {
                document.getElementById('lessonTitle').textContent = lesson.title;
                document.getElementById('lessonDesc').textContent = lesson.description;
                document.getElementById('lessonCategory').textContent = lesson.category;

                if (lesson.video_url) {
                    const videoContainer = document.querySelector('#lessonVideo').parentElement;

                    // Check for Audio
                    const isAudio = lesson.video_url.match(/\.(mp3|wav|ogg|m4a)(\?.*)?$/i);

                    if (isAudio) {
                        videoContainer.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center bg-gray-900 text-white p-8">
                                <i class="fas fa-music text-6xl mb-4 text-brand-teal"></i>
                                <h3 class="text-xl font-bold mb-6">Pelajaran Audio</h3>
                                <audio controls class="w-full max-w-md" crossorigin="anonymous">
                                    <source src="${lesson.video_url}">
                                    Browser Anda tidak mendukung elemen audio.
                                </audio>
                            </div>
                        `;
                    } else {
                        // Simple YouTube Detection
                        const isYouTube = lesson.video_url.includes('youtube.com') || lesson.video_url.includes('youtu.be');

                        if (isYouTube) {
                            // Extract Video ID
                            let videoId = '';
                            if (lesson.video_url.includes('v=')) {
                                videoId = lesson.video_url.split('v=')[1].split('&')[0];
                            } else if (lesson.video_url.includes('youtu.be/')) {
                                videoId = lesson.video_url.split('youtu.be/')[1];
                            }

                            if (videoId) {
                                videoContainer.innerHTML = `
                                    <iframe 
                                        class="w-full h-full"
                                        src="https://www.youtube.com/embed/${videoId}?rel=0" 
                                        title="YouTube video player" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                    ></iframe>
                                `;
                            }
                        } else {
                            // Standard Video
                            document.getElementById('lessonVideo').src = lesson.video_url;
                        }
                    }
                }
            }

            // Load Exercises
            const { data: exercises } = await supabase
                .from('exercises')
                .select('*')
                .eq('lesson_id', lessonId);

            const exercisesList = document.getElementById('exercisesList');
            if (exercises && exercises.length > 0) {
                exercisesList.innerHTML = exercises.map((ex, index) => `
                    <button onclick="openExercise('${ex.id}', '${ex.type}', '${encodeURIComponent(JSON.stringify(ex.content))}')" 
                        class="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 border border-gray-100 hover:bg-white hover:border-brand-teal/50 hover:shadow-md transition-all group text-left">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-sm font-bold text-gray-500 shadow-sm border border-gray-100 group-hover:bg-brand-teal group-hover:text-white transition-colors">${index + 1}</span>
                            <div>
                                <h5 class="font-medium text-gray-800 group-hover:text-brand-teal uppercase text-xs tracking-wider">${ex.type}</h5>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-brand-teal"></i>
                    </button>
                `).join('');
            } else {
                exercisesList.innerHTML = '<p class="text-gray-400 text-sm">Belum ada latihan yang ditambahkan.</p>';
            }
        });

        // Global function for exercise modal
        window.openExercise = (id, type, contentEncoded) => {
            const content = JSON.parse(decodeURIComponent(contentEncoded));
            const modal = document.getElementById('exerciseModal');
            const container = document.getElementById('modalContent');

            let html = '';
            if (content.question) {
                html += `<h3 class="text-xl font-heading font-bold text-brand-black mb-4">${content.question}</h3>`;
            }

            if (type === 'writing') {
                html += `
                    <input type="text" id="exAnswer" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-gray-800 mb-4 focus:ring-1 focus:ring-brand-teal focus:outline-none" placeholder="Ketik jawaban anda...">
                    <button onclick="checkAnswer('${content.answer}')" class="bg-brand-teal text-white px-6 py-2 rounded-lg w-full font-bold">Cek Jawaban</button>
                    ${content.hint ? `<p class="text-gray-400 text-xs mt-3"><i class="fas fa-lightbulb text-yellow-400 mr-1"></i> Petunjuk: ${content.hint}</p>` : ''}
                `;
            } else if (type === 'reading' && content.options) {
                html += `<div class="space-y-3 mb-4">`;
                content.options.forEach(opt => {
                    html += `<button onclick="checkAnswer('${content.answer}', '${opt}')" class="w-full p-3 rounded-lg border border-gray-200 hover:bg-gray-50 text-left text-gray-700">${opt}</button>`;
                });
                html += `</div>`;
            }

            html += `<p id="feedback" class="mt-4 text-center font-bold"></p>`;

            container.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.checkAnswer = (correct, given) => {
            const userAns = given || document.getElementById('exAnswer').value;
            const feedback = document.getElementById('feedback');

            if (userAns.toLowerCase().trim() === correct.toLowerCase().trim()) {
                feedback.textContent = 'Benar! Kerja bagus ðŸŽ‰';
                feedback.className = 'mt-4 text-center font-bold text-green-500';
            } else {
                feedback.textContent = 'Salah. Coba lagi!';
                feedback.className = 'mt-4 text-center font-bold text-red-500';
            }
        };
    </script>
</body>

</html>